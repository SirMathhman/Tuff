#!/bin/sh

# Run Clippy and fail on any warnings
echo "Running cargo clippy..."
cargo clippy --all-targets --all-features -- -D warnings
CLIPPY_EXIT=$?
if [ "$CLIPPY_EXIT" -ne 0 ]; then
  echo "cargo clippy failed (exit code $CLIPPY_EXIT). Commit aborted."
  exit $CLIPPY_EXIT
fi

echo "cargo clippy passed."

# Run PMD CPD and fail on duplicates
echo "Running PMD CPD..."
pwsh -NoProfile -ExecutionPolicy Bypass -File ./run-cpd.ps1
CPD_EXIT=$?
if [ "$CPD_EXIT" -eq 4 ]; then
  echo "PMD CPD found code duplicates (exit code $CPD_EXIT). Commit aborted."
  exit 1
elif [ "$CPD_EXIT" -ne 0 ]; then
  echo "PMD CPD failed (exit code $CPD_EXIT). Commit aborted."
  exit $CPD_EXIT
fi

echo "PMD CPD passed."
exit 0
